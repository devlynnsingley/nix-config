#!/bin/bash

LOCAL=vulcan
REMOTE=hermes

if [[ $1 == --here ]]; then
    function update_direnv() {
        if [[ -d $1 ]]; then
            (cd $1; NIXPKGS_ALLOW_INSECURE=1 de)
        fi
    }
else
    push hermes

    u $LOCAL rebuild
    u $LOCAL copy
    ssh $REMOTE "NIX_CONF=$HOME/src/nix CACHE=$LOCAL u $REMOTE rebuild"

    function update_direnv() {
        if [[ -d $1 ]]; then
            (cd $1; NIXPKGS_ALLOW_INSECURE=1 de)
            ssh $REMOTE "cd $1; CACHE=$LOCAL NIXPKGS_ALLOW_INSECURE=1 de"
        fi
    }
fi


for dir in                                      \
    dfinity/formal-models/coq-governance        \
    dfinity/formal-models/vote-forecast         \
    dfinity/ic-hs                               \
    dfinity/icp-forecast                        \
    dfinity/master/rs                           \
    dfinity/quill                               \
    src/agda/plfa                               \
    src/category-theory                         \
    src/comparable                              \
    src/coq-haskell                             \
    src/coq-jlib                                \
    src/coq-lattice                             \
    src/coq-pipes                               \
    src/linearscan                              \
    src/ltl/coq                                 \
    src/ltl/simple-ltl                          \
    src/ltl/warford                             \
    src/notes/coq                               \
    src/notes/haskell                           \
    src/notes/rust                              \
    src/simple-amount                           \
    src/sitebuilder                             \
    src/trade-journal                           \
    src/wallet
do
    echo "Updating direnv for ~/$dir"
    update_direnv ~/$dir
done
