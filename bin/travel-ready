#!/usr/bin/env bash

LOCAL=vulcan
REMOTE=hermes

export AWS_ACCESS_KEY_ID=$(pass show Passwords/b2-access-key-id | head -1)
export AWS_SECRET_ACCESS_KEY=$(pass show Passwords/b2-access-key | head -1)

if [[ $1 == --here ]]; then
    shift 1
    function update_direnv() {
        if [[ -d $1 ]]; then
            (cd $1; de)
        fi
    }
else
    push $REMOTE

    u $LOCAL rebuild
    u $LOCAL copy

    ssh $REMOTE "NIX_CONF=$HOME/src/nix CACHE=$LOCAL u $REMOTE rebuild"

    function update_direnv() {
        if [[ -d $1 ]]; then
            (cd $1; de)

            ssh $REMOTE "cd $1;                                 \
                CACHE=$LOCAL                                    \
                AWS_ACCESS_KEY_ID='$AWS_ACCESS_KEY_ID'          \
                AWS_SECRET_ACCESS_KEY='$AWS_SECRET_ACCESS_KEY'  \
                de"
        fi
    }
fi

readarray -t projects \
    < <(egrep -v '^(#.+)?$' "${1:-$HOME/.config/projects}")

for dir in "${projects[@]}"; do
    echo "Updating direnv for ~/$dir"
    update_direnv ~/$dir
done
