#!/bin/bash

if [[ "$1" == "vulcan" ]]; then
  HOSTNAME=vulcan
  if [ -z ${CACHE+x} ]; then CACHE=hermes; fi
  if [ -z ${BUILDER+x} ]; then BUILDER=vulcan; fi
  shift 1

elif [[ "$1" == "hermes" ]]; then
  HOSTNAME=hermes
  if [ -z ${CACHE+x} ]; then CACHE=vulcan; fi
  if [ -z ${BUILDER+x} ]; then BUILDER=vulcan; fi
  shift 1

elif [[ "$1" == "athena" ]]; then
  HOSTNAME=athena
  shift 1

elif [[ $(hostname) =~ [Vv]ulcan ]]; then
  HOSTNAME=vulcan
  if [ -z ${CACHE+x} ]; then CACHE=hermes; fi
  if [ -z ${BUILDER+x} ]; then BUILDER=vulcan; fi

elif [[ $(hostname) =~ [Hh]ermes ]]; then
  HOSTNAME=hermes
  if [ -z ${CACHE+x} ]; then CACHE=vulcan; fi
  if [ -z ${BUILDER+x} ]; then BUILDER=vulcan; fi

elif [[ $(hostname) =~ [Aa]thena ]]; then
  HOSTNAME=athena

else
  echo "Cannot recognize HOSTNAME=$HOSTNAME"
  exit 1
fi

echo HOSTNAME=$HOSTNAME
echo CACHE=$CACHE
echo BUILDER=$BUILDER

MAKEARGS="-C $NIX_CONF -f Makefile HOSTNAME=$HOSTNAME"

if [[ $HOSTNAME != $BUILDER ]]; then
    MAKEARGS="$MAKEARGS BUILDER=$BUILDER"
fi
if [[ $HOSTNAME != $CACHE ]]; then
    MAKEARGS="$MAKEARGS CACHE=$CACHE"
fi

cd $NIX_CONF
exec make $MAKEARGS "$@"
